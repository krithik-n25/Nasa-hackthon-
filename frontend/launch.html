<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MISSION: HARVEST</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: #000000;
        color: #ffffff;
        overflow-x: hidden;
      }

      .top-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: linear-gradient(
          135deg,
          #051f14 0%,
          #031a10 50%,
          #02140c 100%
        );
        border-bottom: 0.5px solid #047857;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 40px;
        z-index: 1000;
        box-shadow: 0 4px 30px rgba(4, 120, 87, 0.2);
      }

      .back-btn {
        background: linear-gradient(
          135deg,
          rgba(4, 120, 87, 0.15),
          rgba(4, 120, 87, 0.08)
        );
        border: 0.5px solid #047857;
        color: #047857;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .back-btn:hover {
        background: linear-gradient(135deg, #047857, #035a44);
        color: #000;
        transform: translateX(-5px);
      }

      .challenge-title {
        font-family: "Orbitron", sans-serif;
        font-size: 26px;
        font-weight: 700;
        color: #ffffff;
        letter-spacing: 2px;
      }

      .points-counter {
        background: linear-gradient(
          135deg,
          rgba(4, 120, 87, 0.15),
          rgba(4, 120, 87, 0.08)
        );
        border: 0.5px solid #047857;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: bold;
        color: #047857;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
      }

      .main-content {
        margin-top: 100px;
        padding: 20px;
        display: grid;
        grid-template-columns: 320px 1fr 340px;
        gap: 25px;
        max-width: 1900px;
        margin-left: auto;
        margin-right: auto;
      }

      .metadata-panel {
        background: linear-gradient(135deg, #051f14 0%, #041a10 100%);
        border: 0.5px solid #047857;
        border-radius: 15px;
        padding: 25px;
        height: fit-content;
        box-shadow: 0 8px 30px rgba(4, 120, 87, 0.15);
      }

      .metadata-panel h2 {
        font-family: "Orbitron", sans-serif;
        color: #ffffff;
        margin-bottom: 25px;
        font-size: 20px;
        text-align: center;
        border-bottom: 1px solid #047857;
        padding-bottom: 12px;
      }

      .meta-item {
        margin-bottom: 18px;
        padding: 12px;
        background: rgba(4, 120, 87, 0.08);
        border-radius: 10px;
        border-left: 2px solid #047857;
        transition: all 0.3s;
      }

      .meta-item:hover {
        background: rgba(4, 120, 87, 0.12);
        transform: translateX(5px);
      }

      .meta-label {
        color: #ffffff;
        font-weight: bold;
        font-size: 12px;
        margin-bottom: 5px;
      }

      .meta-value {
        color: #d1d5db;
        font-size: 14px;
      }

      .nasa-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .badge {
        background: rgba(4, 120, 87, 0.15);
        border: 0.5px solid #047857;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 11px;
        color: #047857;
      }

      .field-container {
        background: linear-gradient(135deg, #051f14 0%, #041a10 100%);
        border: 0.5px solid #047857;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 30px rgba(4, 120, 87, 0.15);
        display: flex;
        flex-direction: column;
        gap: 25px;
      }

      .field-header {
        text-align: center;
      }

      .field-header h1 {
        font-family: "Orbitron", sans-serif;
        font-size: 38px;
        color: #ffffff;
        letter-spacing: 6px;
        margin-bottom: 12px;
        font-weight: 900;
      }

      .turn-counter {
        color: #ffffff;
        font-size: 16px;
        font-weight: bold;
      }

      .field-3d {
        width: 100%;
        height: 500px;
        border: 0.5px solid #047857;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        background: #000000;
      }

      .action-controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .action-btn {
        background: rgba(4, 120, 87, 0.15);
        border: 0.5px solid #047857;
        color: #047857;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
      }

      .action-btn:hover {
        background: #047857;
        color: #000;
        transform: translateY(-2px);
      }

      .stats-panel {
        background: linear-gradient(135deg, #051f14 0%, #041a10 100%);
        border: 0.5px solid #047857;
        border-radius: 15px;
        padding: 25px;
        height: fit-content;
        box-shadow: 0 8px 30px rgba(4, 120, 87, 0.15);
      }

      .stats-panel h2 {
        font-family: "Orbitron", sans-serif;
        color: #ffffff;
        margin-bottom: 25px;
        font-size: 20px;
        text-align: center;
        border-bottom: 1px solid #047857;
        padding-bottom: 12px;
      }

      .stat-item {
        margin-bottom: 20px;
      }

      .stat-label {
        color: #ffffff;
        font-size: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: rgba(4, 120, 87, 0.1);
        border: 0.5px solid #047857;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #047857 0%, #035a44 100%);
        transition: width 0.5s ease;
        border-radius: 10px;
      }

      .stat-value {
        color: #ffffff;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-top: 5px;
      }

      .insights-panel {
        background: rgba(4, 120, 87, 0.08);
        border: 0.5px solid #047857;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
      }

      .insights-panel h3 {
        color: #ffffff;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .insight-text {
        color: #d1d5db;
        font-size: 12px;
        line-height: 1.6;
      }

      .harvest-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #047857, #035a44);
        color: #ffffff;
        border: none;
        padding: 18px 40px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 6px 25px rgba(4, 120, 87, 0.4);
        transition: all 0.3s;
        z-index: 999;
        font-family: "Orbitron", sans-serif;
        letter-spacing: 2px;
      }

      .harvest-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 30px rgba(4, 120, 87, 0.6);
      }

      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9998;
        backdrop-filter: blur(10px);
      }

      .modal-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .harvest-modal {
        background: linear-gradient(135deg, #051f14 0%, #041a10 100%);
        border: 1px solid #047857;
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(4, 120, 87, 0.4);
        animation: slideUp 0.4s ease;
        position: relative;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .harvest-modal::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #047857, #10b981, #047857);
      }

      .modal-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .modal-header h2 {
        font-family: "Orbitron", sans-serif;
        font-size: 32px;
        color: #ffffff;
        margin-bottom: 10px;
        letter-spacing: 3px;
      }

      .modal-status {
        font-size: 18px;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 8px;
        display: inline-block;
        margin-top: 10px;
      }

      .modal-status.success {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid #10b981;
      }

      .modal-status.failure {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
      }

      .modal-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
      }

      .modal-stat {
        background: rgba(4, 120, 87, 0.1);
        border: 0.5px solid #047857;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s;
      }

      .modal-stat:hover {
        background: rgba(4, 120, 87, 0.15);
        transform: translateY(-2px);
      }

      .modal-stat-label {
        color: #d1d5db;
        font-size: 12px;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .modal-stat-value {
        color: #ffffff;
        font-size: 28px;
        font-weight: bold;
      }

      .modal-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      .modal-btn {
        flex: 1;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-size: 16px;
      }

      .modal-btn.primary {
        background: linear-gradient(135deg, #047857, #035a44);
        color: #ffffff;
      }

      .modal-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(4, 120, 87, 0.4);
      }

      .modal-btn.secondary {
        background: rgba(4, 120, 87, 0.15);
        color: #047857;
        border: 0.5px solid #047857;
      }

      .modal-btn.secondary:hover {
        background: rgba(4, 120, 87, 0.25);
      }

      .toast {
        position: fixed;
        bottom: 100px;
        right: 30px;
        background: #051f14;
        border: 0.5px solid #047857;
        padding: 15px 20px;
        border-radius: 8px;
        color: #047857;
        font-weight: bold;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s;
        z-index: 2000;
        max-width: 300px;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="top-nav">
      <button class="back-btn" onclick="window.location.href='stimulator.html'">← Back</button>

      <div class="challenge-title">Optimizing Irrigation in Punjab </div>
      <div class="points-counter">
        🌳 <span id="totalPoints">600</span> points
      </div>
    </div>

    <div class="main-content">
      <div class="metadata-panel">
        <h2>📋 CHALLENGE INFO</h2>
        <div class="meta-item">
          <div class="meta-label">🌍 LOCATION</div>
          <div class="meta-value">Punjab, India</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">☁ TEMPERATURE</div>
          <div class="meta-value">28°C</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">🌱 INITIAL SOIL MOISTURE</div>
          <div class="meta-value">45%</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">💰 BUDGET</div>
          <div class="meta-value">$5000</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">🧠 GOAL</div>
          <div class="meta-value">
            Reduce irrigation by 20% without lowering wheat yield below 4 t/ha 
          </div>
        </div>
        <div class="meta-item">
          <div class="meta-label">🐄 LIVESTOCK</div>
          <div class="meta-value">20 cows</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">🛰 NASA DATASETS</div>
          <div class="nasa-badges">
            <span class="badge">SMAP</span>
            <span class="badge">GPM</span>
          </div>
        </div>
      </div>

      <div class="field-container">
        <div class="field-header">
          <h1>MISSION: HARVEST</h1>
          <div class="turn-counter">Day <span id="currentDay">1</span> / 7</div>
        </div>

        <div class="field-3d" id="field3d"></div>

        <div class="action-controls">
          <button class="action-btn" onclick="irrigate()">
            💧 Irrigate ($100)
          </button>
          <button class="action-btn" onclick="fertilize()">
            🌾 Fertilize ($150)
          </button>
          <button class="action-btn" onclick="pesticide()">
            🐛 Apply Pesticide ($80)
          </button>
          <button class="action-btn" onclick="feedLivestock()">
            🐄 Feed Livestock ($50)
          </button>
        </div>
      </div>

      <div class="stats-panel">
        <h2>📈 LIVE STATS</h2>
        <div class="stat-item">
          <div class="stat-label">
            <span>🌱 Soil Moisture</span>
            <span id="moisturePercent">10%</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="moistureFill"
              style="width: 10%"
            ></div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <span>🍃 Vegetation Health</span>
            <span id="ndviStatus">Poor</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="ndviFill" style="width: 25%"></div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <span>🐄 Livestock Health</span>
            <span id="livestockHealth">60%</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="livestockFill"
              style="width: 60%"
            ></div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">📦 Yield Estimate</div>
          <div class="stat-value" id="yieldEstimate">0 kg</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">💰 Budget Remaining</div>
          <div class="stat-value" id="budgetRemaining">$2000</div>
        </div>
        <div class="insights-panel">
          <h3>🌐 NASA INSIGHT</h3>
          <div class="insight-text" id="insightText">
            SMAP monitors soil moisture globally from space, helping farmers
            optimize irrigation timing.
          </div>
        </div>
      </div>
    </div>

    <button class="harvest-btn" onclick="showHarvestModal()">🌾 HARVEST</button>

    <div class="modal-overlay" id="modalOverlay">
      <div class="harvest-modal">
        <div class="modal-header">
          <h2>🌾 HARVEST REPORT</h2>
          <div class="modal-status" id="modalStatus">Mission Complete</div>
        </div>
        <div class="modal-stats">
          <div class="modal-stat">
            <div class="modal-stat-label">Total Yield</div>
            <div class="modal-stat-value" id="modalYield">0 kg</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">Points Earned</div>
            <div class="modal-stat-value" id="modalPoints">+0</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">Money Used</div>
            <div class="modal-stat-value" id="modalMoneyUsed">$0</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">Money Saved</div>
            <div class="modal-stat-value" id="modalMoneySaved">$0</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">Soil Moisture</div>
            <div class="modal-stat-value" id="modalMoisture">0%</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">Vegetation</div>
            <div class="modal-stat-value" id="modalVegetation">0%</div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn secondary" onclick="closeModal()">
            Close
          </button>
          <button class="modal-btn primary" onclick="returnToDashboard()">
            Return to Dashboard
          </button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      let gameState = {
        soilMoisture: 10,
        vegetationHealth: 25,
        livestockHealth: 60,
        yieldEstimate: 0,
        budget: 2000,
        initialBudget: 2000,
        currentDay: 1,
        totalPoints: parseInt(localStorage.getItem("totalPoints") || "600"),
      };

      let scene,
        camera,
        renderer,
        fieldGroup,
        cropMeshes = [];

      const insights = [
        "SMAP monitors soil moisture globally from space, helping farmers optimize irrigation timing.",
        "MODIS tracks vegetation health through NDVI, showing crop stress before it's visible to the eye.",
        "ECOSTRESS measures plant temperature from space, detecting water stress in crops.",
        "GRACE monitors groundwater levels, crucial for irrigation planning in drought-prone areas.",
        "GPM provides rainfall data helping farmers predict water availability for their crops.",
      ];

      let currentInsightIndex = 0;

      function initThreeJS() {
        const container = document.getElementById("field3d");
        const width = container.clientWidth;
        const height = container.clientHeight;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Sky blue for daytime
        scene.fog = new THREE.Fog(0x87ceeb, 50, 200);

        camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
        camera.position.set(0, 15, 20);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Lights - Daytime atmosphere
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // Brighter ambient for daytime
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffd700, 1.2); // Golden sunlight
        directionalLight.position.set(50, 100, 50); // Higher sun position
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.near = 0.1;
        directionalLight.shadow.camera.far = 500;
        directionalLight.shadow.camera.left = -100;
        directionalLight.shadow.camera.right = 100;
        directionalLight.shadow.camera.top = 100;
        directionalLight.shadow.camera.bottom = -100;
        scene.add(directionalLight);

        // Remove green light for daytime

        // Ground - Dark brown base
        const groundGeometry = new THREE.PlaneGeometry(30, 30);
        const groundMaterial = new THREE.MeshStandardMaterial({
          color: 0x3c2415, // Dark brown base color
          roughness: 0.9,
          metalness: 0.1,
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        fieldGroup = new THREE.Group();
        scene.add(fieldGroup);

        const rows = 8,
          cols = 10,
          spacing = 2.5;
        for (let i = 0; i < rows; i++) {
          for (let j = 0; j < cols; j++) {
            const x = (j - cols / 2) * spacing;
            const z = (i - rows / 2) * spacing;

            // Soil plot - Brown soil
            const plotGeometry = new THREE.BoxGeometry(2, 0.3, 2);
            const plotMaterial = new THREE.MeshStandardMaterial({
              color: 0x8b4513, // Brown soil color
              roughness: 0.9,
            });
            const plot = new THREE.Mesh(plotGeometry, plotMaterial);
            plot.position.set(x, 0.15, z);
            plot.castShadow = true;
            plot.receiveShadow = true;
            fieldGroup.add(plot);

            const cropGroup = new THREE.Group();
            cropGroup.position.set(x, 0.3, z);
            cropGroup.userData.stage = 0;
            fieldGroup.add(cropGroup);
            cropMeshes.push(cropGroup);
          }
        }

        // Add some clouds for daytime atmosphere
        const cloudGeometry = new THREE.SphereGeometry(5, 8, 8);
        const cloudMaterial = new THREE.MeshBasicMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.7,
        });

        // Add a few clouds
        for (let i = 0; i < 3; i++) {
          const cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
          cloud.position.set(
            (Math.random() - 0.5) * 60,
            25 + Math.random() * 10,
            (Math.random() - 0.5) * 60
          );
          cloud.scale.setScalar(0.5 + Math.random() * 0.5);
          scene.add(cloud);
        }

        animate();
      }

      function createCropMesh(stage) {
        const group = new THREE.Group();

        if (stage === 1) {
          // Seedling stage - small green shoots
          for (let i = 0; i < 3; i++) {
            const shootGeo = new THREE.CylinderGeometry(0.02, 0.03, 0.3, 6);
            const shootMat = new THREE.MeshStandardMaterial({
              color: 0x4ade80,
              roughness: 0.7,
            });
            const shoot = new THREE.Mesh(shootGeo, shootMat);
            shoot.position.set(
              (Math.random() - 0.5) * 0.3,
              0.15,
              (Math.random() - 0.5) * 0.3
            );
            shoot.rotation.z = (Math.random() - 0.5) * 0.2;
            shoot.castShadow = true;
            group.add(shoot);

            // Small blade leaves
            const bladeGeo = new THREE.PlaneGeometry(0.05, 0.2);
            const bladeMat = new THREE.MeshStandardMaterial({
              color: 0x22c55e,
              side: THREE.DoubleSide,
              roughness: 0.8,
            });
            const blade = new THREE.Mesh(bladeGeo, bladeMat);
            blade.position.set(shoot.position.x, 0.25, shoot.position.z);
            blade.rotation.y = Math.random() * Math.PI * 2;
            blade.castShadow = true;
            group.add(blade);
          }
        } else if (stage === 2) {
          // Tillering stage - multiple stems with longer leaves
          for (let i = 0; i < 5; i++) {
            const stemGeo = new THREE.CylinderGeometry(0.03, 0.04, 0.8, 8);
            const stemMat = new THREE.MeshStandardMaterial({
              color: 0x16a34a,
              roughness: 0.6,
            });
            const stem = new THREE.Mesh(stemGeo, stemMat);
            stem.position.set(
              (Math.random() - 0.5) * 0.4,
              0.4,
              (Math.random() - 0.5) * 0.4
            );
            stem.rotation.z = (Math.random() - 0.5) * 0.15;
            stem.castShadow = true;
            group.add(stem);

            // Wheat blade leaves
            for (let j = 0; j < 3; j++) {
              const leafGeo = new THREE.PlaneGeometry(0.08, 0.6);
              const leafMat = new THREE.MeshStandardMaterial({
                color: 0x15803d,
                side: THREE.DoubleSide,
                roughness: 0.7,
              });
              const leaf = new THREE.Mesh(leafGeo, leafMat);
              leaf.position.set(
                stem.position.x + (Math.random() - 0.5) * 0.1,
                0.5 + j * 0.2,
                stem.position.z + (Math.random() - 0.5) * 0.1
              );
              leaf.rotation.y = Math.random() * Math.PI * 2;
              leaf.rotation.z = (Math.random() - 0.5) * 0.3;
              leaf.castShadow = true;
              group.add(leaf);
            }
          }
        } else if (stage === 3) {
          // Stem elongation - taller stems, early head formation
          for (let i = 0; i < 4; i++) {
            const stemGeo = new THREE.CylinderGeometry(0.04, 0.05, 1.4, 8);
            const stemMat = new THREE.MeshStandardMaterial({
              color: 0x166534,
              roughness: 0.5,
            });
            const stem = new THREE.Mesh(stemGeo, stemMat);
            stem.position.set(
              (Math.random() - 0.5) * 0.3,
              0.7,
              (Math.random() - 0.5) * 0.3
            );
            stem.rotation.z = (Math.random() - 0.5) * 0.1;
            stem.castShadow = true;
            group.add(stem);

            // Longer leaves
            for (let j = 0; j < 4; j++) {
              const leafGeo = new THREE.PlaneGeometry(0.1, 0.8);
              const leafMat = new THREE.MeshStandardMaterial({
                color: 0x15803d,
                side: THREE.DoubleSide,
                roughness: 0.6,
              });
              const leaf = new THREE.Mesh(leafGeo, leafMat);
              leaf.position.set(
                stem.position.x + (Math.random() - 0.5) * 0.08,
                0.6 + j * 0.2,
                stem.position.z + (Math.random() - 0.5) * 0.08
              );
              leaf.rotation.y = Math.random() * Math.PI * 2;
              leaf.rotation.z = (Math.random() - 0.5) * 0.4;
              leaf.castShadow = true;
              group.add(leaf);
            }

            // Early wheat head formation
            const headGeo = new THREE.CylinderGeometry(0.08, 0.06, 0.3, 8);
            const headMat = new THREE.MeshStandardMaterial({
              color: 0x84cc16,
              roughness: 0.4,
            });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.set(stem.position.x, 1.5, stem.position.z);
            head.castShadow = true;
            group.add(head);
          }
        } else if (stage === 4) {
          // Mature wheat - full heads with grains
          for (let i = 0; i < 4; i++) {
            const stemGeo = new THREE.CylinderGeometry(0.05, 0.06, 1.8, 8);
            const stemMat = new THREE.MeshStandardMaterial({
              color: 0xca8a04,
              roughness: 0.4,
            });
            const stem = new THREE.Mesh(stemGeo, stemMat);
            stem.position.set(
              (Math.random() - 0.5) * 0.25,
              0.9,
              (Math.random() - 0.5) * 0.25
            );
            stem.castShadow = true;
            group.add(stem);

            // Mature leaves (yellowing)
            for (let j = 0; j < 3; j++) {
              const leafGeo = new THREE.PlaneGeometry(0.12, 0.9);
              const leafMat = new THREE.MeshStandardMaterial({
                color: 0xa3a3a3,
                side: THREE.DoubleSide,
                roughness: 0.8,
              });
              const leaf = new THREE.Mesh(leafGeo, leafMat);
              leaf.position.set(
                stem.position.x + (Math.random() - 0.5) * 0.06,
                0.8 + j * 0.2,
                stem.position.z + (Math.random() - 0.5) * 0.06
              );
              leaf.rotation.y = Math.random() * Math.PI * 2;
              leaf.rotation.z = (Math.random() - 0.5) * 0.5;
              leaf.castShadow = true;
              group.add(leaf);
            }

            // Mature wheat head with individual grains
            const headGeo = new THREE.CylinderGeometry(0.12, 0.08, 0.6, 8);
            const headMat = new THREE.MeshStandardMaterial({
              color: 0xfbbf24,
              roughness: 0.3,
            });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.set(stem.position.x, 2.1, stem.position.z);
            head.castShadow = true;
            group.add(head);

            // Individual wheat grains
            for (let k = 0; k < 12; k++) {
              const grainGeo = new THREE.SphereGeometry(0.02, 6, 6);
              const grainMat = new THREE.MeshStandardMaterial({
                color: 0xf59e0b,
                roughness: 0.2,
              });
              const grain = new THREE.Mesh(grainGeo, grainMat);
              const angle = (k / 12) * Math.PI * 2;
              const radius = 0.08 + (k % 3) * 0.02;
              grain.position.set(
                stem.position.x + Math.cos(angle) * radius,
                1.9 + (k % 4) * 0.1,
                stem.position.z + Math.sin(angle) * radius
              );
              grain.castShadow = true;
              group.add(grain);
            }

            // Awns (wheat bristles)
            for (let a = 0; a < 8; a++) {
              const awnGeo = new THREE.CylinderGeometry(0.005, 0.005, 0.4, 4);
              const awnMat = new THREE.MeshStandardMaterial({
                color: 0xeab308,
                roughness: 0.9,
              });
              const awn = new THREE.Mesh(awnGeo, awnMat);
              const angle = (a / 8) * Math.PI * 2;
              awn.position.set(
                stem.position.x + Math.cos(angle) * 0.1,
                2.3,
                stem.position.z + Math.sin(angle) * 0.1
              );
              awn.rotation.z = Math.cos(angle) * 0.3;
              awn.rotation.x = Math.sin(angle) * 0.3;
              awn.castShadow = true;
              group.add(awn);
            }
          }
        } else if (stage === -1) {
          // Drought-stressed/dead wheat
          for (let i = 0; i < 2; i++) {
            const stemGeo = new THREE.CylinderGeometry(0.03, 0.04, 0.6, 6);
            const stemMat = new THREE.MeshStandardMaterial({
              color: 0x78350f,
              roughness: 0.9,
            });
            const stem = new THREE.Mesh(stemGeo, stemMat);
            stem.position.set(
              (Math.random() - 0.5) * 0.4,
              0.3,
              (Math.random() - 0.5) * 0.4
            );
            stem.rotation.z = (Math.random() - 0.5) * 0.8;
            stem.castShadow = true;
            group.add(stem);

            // Withered leaves
            for (let j = 0; j < 2; j++) {
              const leafGeo = new THREE.PlaneGeometry(0.06, 0.4);
              const leafMat = new THREE.MeshStandardMaterial({
                color: 0x451a03,
                side: THREE.DoubleSide,
                roughness: 0.9,
              });
              const leaf = new THREE.Mesh(leafGeo, leafMat);
              leaf.position.set(
                stem.position.x + (Math.random() - 0.5) * 0.1,
                0.4 + j * 0.1,
                stem.position.z + (Math.random() - 0.5) * 0.1
              );
              leaf.rotation.y = Math.random() * Math.PI * 2;
              leaf.rotation.z = (Math.random() - 0.5) * 0.8;
              leaf.castShadow = true;
              group.add(leaf);
            }
          }
        }

        return group;
      }

      function updateCropVisuals() {
        const stage =
          gameState.vegetationHealth < 30
            ? -1
            : gameState.vegetationHealth < 40
            ? 1
            : gameState.vegetationHealth < 60
            ? 2
            : gameState.vegetationHealth < 80
            ? 3
            : 4;

        cropMeshes.forEach((cropGroup) => {
          if (cropGroup.userData.stage !== stage) {
            while (cropGroup.children.length > 0) {
              cropGroup.remove(cropGroup.children[0]);
            }

            const newCrop = createCropMesh(stage);
            newCrop.userData.swayOffset = Math.random() * Math.PI * 2;
            newCrop.userData.swaySpeed = 0.5 + Math.random() * 0.5;

            cropGroup.add(newCrop);
            cropGroup.userData.stage = stage;
            cropGroup.userData.cropMesh = newCrop;
          }
        });
      }

      function animate() {
        requestAnimationFrame(animate);

        const time = Date.now() * 0.001;

        if (fieldGroup) {
          fieldGroup.rotation.y = time * 0.1;
        }

        cropMeshes.forEach((cropGroup) => {
          if (cropGroup.userData.cropMesh) {
            const crop = cropGroup.userData.cropMesh;
            if (crop.userData.swaySpeed !== undefined) {
              crop.rotation.z =
                Math.sin(
                  time * crop.userData.swaySpeed + crop.userData.swayOffset
                ) * 0.05;
            }
          }
        });

        if (renderer && scene && camera) {
          renderer.render(scene, camera);
        }
      }

      window.addEventListener("resize", () => {
        const container = document.getElementById("field3d");
        const width = container.clientWidth;
        const height = container.clientHeight;

        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      });

      function init() {
        document.getElementById("totalPoints").textContent =
          gameState.totalPoints;
        initThreeJS();
        updateAllStats();
      }

      function updateAllStats() {
        document.getElementById("moisturePercent").textContent =
          gameState.soilMoisture + "%";
        document.getElementById("moistureFill").style.width =
          gameState.soilMoisture + "%";

        const ndviStatus =
          gameState.vegetationHealth < 40
            ? "Poor"
            : gameState.vegetationHealth < 70
            ? "Moderate"
            : "Healthy";
        document.getElementById("ndviStatus").textContent = ndviStatus;
        document.getElementById("ndviFill").style.width =
          gameState.vegetationHealth + "%";

        document.getElementById("livestockHealth").textContent =
          gameState.livestockHealth + "%";
        document.getElementById("livestockFill").style.width =
          gameState.livestockHealth + "%";

        document.getElementById("yieldEstimate").textContent =
          gameState.yieldEstimate + " kg";
        document.getElementById("budgetRemaining").textContent =
          "$" + gameState.budget;
        document.getElementById("currentDay").textContent =
          gameState.currentDay;

        updateCropVisuals();
      }

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      function irrigate() {
        if (gameState.budget < 100) {
          showToast("Insufficient budget!");
          return;
        }
        gameState.budget -= 100;
        gameState.soilMoisture = Math.min(100, gameState.soilMoisture + 25);
        gameState.vegetationHealth = Math.min(
          100,
          gameState.vegetationHealth + 15
        );
        gameState.yieldEstimate = Math.floor(gameState.vegetationHealth * 5);
        gameState.currentDay++;
        updateAllStats();
        showToast("Irrigation complete! SMAP data updated.");
        rotateInsight();
      }

      function fertilize() {
        if (gameState.budget < 150) {
          showToast("Insufficient budget!");
          return;
        }
        gameState.budget -= 150;
        gameState.vegetationHealth = Math.min(
          100,
          gameState.vegetationHealth + 20
        );
        gameState.yieldEstimate = Math.floor(gameState.vegetationHealth * 5);
        gameState.currentDay++;
        updateAllStats();
        showToast("Fertilizer applied! MODIS shows improvement.");
        rotateInsight();
      }

      function pesticide() {
        if (gameState.budget < 80) {
          showToast("Insufficient budget!");
          return;
        }
        gameState.budget -= 80;
        gameState.vegetationHealth = Math.min(
          100,
          gameState.vegetationHealth + 10
        );
        gameState.yieldEstimate = Math.floor(gameState.vegetationHealth * 5);
        gameState.currentDay++;
        updateAllStats();
        showToast("Pest protection applied successfully!");
        rotateInsight();
      }

      function feedLivestock() {
        if (gameState.budget < 50) {
          showToast("Insufficient budget!");
          return;
        }
        gameState.budget -= 50;
        gameState.livestockHealth = Math.min(
          100,
          gameState.livestockHealth + 20
        );
        gameState.currentDay++;
        updateAllStats();
        showToast("Livestock health improved!");
        rotateInsight();
      }

      function rotateInsight() {
        currentInsightIndex = (currentInsightIndex + 1) % insights.length;
        document.getElementById("insightText").textContent =
          insights[currentInsightIndex];
      }

      function showHarvestModal() {
        const moneyUsed = gameState.initialBudget - gameState.budget;
        const moneySaved = gameState.budget;
        const goalMet =
          gameState.yieldEstimate >= 300 && gameState.soilMoisture >= 40;
        const pointsEarned = goalMet ? 100 : 0;

        document.getElementById("modalYield").textContent =
          gameState.yieldEstimate + " kg";
        document.getElementById("modalPoints").textContent = "+" + pointsEarned;
        document.getElementById("modalMoneyUsed").textContent = "$" + moneyUsed;
        document.getElementById("modalMoneySaved").textContent =
          "$" + moneySaved;
        document.getElementById("modalMoisture").textContent =
          gameState.soilMoisture + "%";
        document.getElementById("modalVegetation").textContent =
          gameState.vegetationHealth + "%";

        const statusEl = document.getElementById("modalStatus");
        if (goalMet) {
          statusEl.textContent = "Mission Success!";
          statusEl.className = "modal-status success";
          gameState.totalPoints += pointsEarned;
          localStorage.setItem("totalPoints", gameState.totalPoints);
        } else {
          statusEl.textContent = "Mission Failed";
          statusEl.className = "modal-status failure";
        }

        document.getElementById("modalOverlay").classList.add("show");
      }

      function closeModal() {
        document.getElementById("modalOverlay").classList.remove("show");
      }

      function returnToDashboard() {
        window.location.href = "stimulator.html";
      }

      function goBack() {
        if (confirm("Are you sure you want to leave? Progress will be lost.")) {
          window.location.href = "stimulator.html";
        }
      }

      setInterval(() => {
        if (gameState.currentDay < 7) {
          gameState.soilMoisture = Math.max(0, gameState.soilMoisture - 3);
          gameState.vegetationHealth = Math.max(
            0,
            gameState.vegetationHealth - 2
          );
          gameState.livestockHealth = Math.max(
            0,
            gameState.livestockHealth - 1
          );
          updateAllStats();
        }
      }, 10000);

      window.onload = init;
    </script>
  </body>
</html>
